{% extends "base.html" %} {% block title %}Main{% endblock %} {% block content
%}
<div class="container">
  <div class="page-header">
    <h1>Main</h1>
  </div>

  <div class="dashboard-grid">
    <div class="dashboard-card">
      <div class="card-icon-wrapper">
        <div class="card-icon"></div>
      </div>
      <h3>Secure Messaging</h3>
      <p>Send and receive encrypted messages</p>
      <a href="{{ url_for('messaging_page') }}" class="btn btn-primary"
        >Open Messaging</a
      >
    </div>

    <div class="dashboard-card">
      <div class="card-icon-wrapper">
        <div class="card-icon"></div>
      </div>
      <h3>File Encryption</h3>
      <p>Encrypt and decrypt files</p>
      <a href="{{ url_for('files_page') }}" class="btn btn-primary"
        >Manage Files</a
      >
    </div>

    <div class="dashboard-card">
      <div class="card-icon-wrapper">
        <div class="card-icon"></div>
      </div>
      <h3>Audit Trail</h3>
      <p>View blockchain audit log</p>
      <a href="{{ url_for('audit_page') }}" class="btn btn-primary"
        >View Audit</a
      >
    </div>

    <div class="dashboard-card">
      <div class="card-icon-wrapper">
        <div class="card-icon"></div>
      </div>
      <h3>Two-Factor Auth</h3>
      <p>Setup TOTP</p>
      <button onclick="setupTOTP()" class="btn btn-secondary">
        Setup TOTP
      </button>
    </div>
  </div>

  <div id="totpModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>TOTP Setup</h2>
      <div id="totpContent"></div>
    </div>
  </div>
</div>

<script>
  async function setupTOTP() {
    try {
      const response = await fetch("/setup_totp", { method: "POST" });
      const data = await response.json();

      if (data.success) {
        const modal = document.getElementById("totpModal");
        const content = document.getElementById("totpContent");

        content.innerHTML = `
                <p>Scan this QR code with your authenticator app:</p>
                <img src="${
                  data.data.qr_code
                }" alt="TOTP QR Code" style="max-width: 300px; display:block; margin-bottom: 0.5rem;">
                <p><strong>Secret key (Base32):</strong></p>
                <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.5rem;">
                    <code id="totpSecret" style="padding:0.5rem;border-radius:6px;background:#0b1220;border:1px solid rgba(255,255,255,0.04);">${
                      data.data.secret
                    }</code>
                    <button id="copySecretBtn" class="btn btn-secondary">Copy</button>
                </div>
                
                <p><strong>Backup Codes:</strong></p>
                <ul>
                    ${data.data.backup_codes
                      .map((code) => `<li>${code}</li>`)
                      .join("")}
                </ul>
                <p><small>Save these backup codes in a secure location!</small></p>
            `;

        modal.style.display = "block";
      }
    } catch (error) {
      alert("Failed to setup TOTP");
    }
  }

  document.querySelector(".close").onclick = function () {
    document.getElementById("totpModal").style.display = "none";
  };
  // Copy secret button handler
  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "copySecretBtn") {
      const secretEl = document.getElementById("totpSecret");
      if (!secretEl) return;
      const text = secretEl.textContent || secretEl.innerText || "";
      navigator.clipboard
        .writeText(text)
        .then(() => {
          alert("Secret copied to clipboard");
        })
        .catch(() => {
          alert("Failed to copy secret");
        });
    }
  });
</script>
{% endblock %}
