{% extends "base.html" %} {% block title %}Reset Password{% endblock %} {% block
content %}
<div class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <h2>Reset Password</h2>
    </div>
    <form id="resetForm" class="auth-form" novalidate>
      <div class="form-group">
        <label for="password"> New Password</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          minlength="8"
          pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}"
          title="Must contain uppercase, lowercase, digit, and special character"
          autocomplete="new-password"
        />
        <small
          >Must contain uppercase, lowercase, digit, and special
          character</small
        >
      </div>
      <div class="form-group">
        <label for="confirm_password"> Confirm Password</label>
        <input
          type="password"
          id="confirm_password"
          name="confirm_password"
          required
          minlength="8"
          pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}"
          title="Must contain uppercase, lowercase, digit, and special character"
          autocomplete="new-password"
        />
      </div>
      <button type="submit" class="btn btn-primary btn-block">
        Reset Password
      </button>
      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>
    </form>
    <div class="auth-footer">
      <p>
        Remembered your password?
        <a href="{{ url_for('login') }}">Back to login</a>
      </p>
    </div>
  </div>
</div>

<script>
  // Add "touched" class to fields after input for proper validation styling
  document.querySelectorAll(".form-group input").forEach((input) => {
    input.addEventListener("blur", function () {
      if (this.value.length > 0) {
        this.classList.add("touched");
      }
    });

    input.addEventListener("input", function () {
      if (this.value.length > 0) {
        this.classList.add("touched");
      }
    });
  });

  document.getElementById("resetForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const errorDiv = document.getElementById("errorMessage");
    const successDiv = document.getElementById("successMessage");
    errorDiv.textContent = "";
    successDiv.textContent = "";

    // Add touched class to all fields on submit
    document.querySelectorAll(".form-group input").forEach((input) => {
      if (input.value.length > 0) {
        input.classList.add("touched");
      }
    });

    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm_password").value;

    const pwdPattern = /(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}/;

    if (!pwdPattern.test(password) || !pwdPattern.test(confirmPassword)) {
      errorDiv.textContent =
        "Password must contain uppercase, lowercase, digit, and special character and be at least 8 characters long";
      return;
    }

    if (password !== confirmPassword) {
      errorDiv.textContent = "Passwords do not match";
      return;
    }

    try {
      const response = await fetch(window.location.pathname, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password }),
      });

      const data = await response.json();

      if (data.success) {
        successDiv.textContent =
          "Password reset successful! You can now log in.";
        setTimeout(() => {
          window.location.href = '{{ url_for("login") }}';
        }, 2000);
      } else {
        errorDiv.textContent = data.error || "Password reset failed";
      }
    } catch (error) {
      errorDiv.textContent = "Network error. Please try again.";
    }
  });
</script>

{% endblock %}
