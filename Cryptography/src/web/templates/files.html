{% extends "base.html" %} {% block title %}File Encryption{% endblock %} {%
block content %}
<div class="container">
  <div class="page-header">
    <h1>File Encryption</h1>
    <p>Secure file storage and sharing</p>
  </div>

  <div class="files-container">
    <div class="file-panel">
      <h3>Encrypt File</h3>
      <form id="encryptForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="fileInput">Select File</label>
          <input type="file" id="fileInput" name="file" required />
        </div>
        <div class="form-group">
          <label for="encryptPassword">Encryption Password</label>
          <input
            type="password"
            id="encryptPassword"
            name="password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">Encrypt File</button>
      </form>
      <div id="encryptResult" class="result-display"></div>
    </div>

    <div class="file-panel">
      <h3>Decrypt File</h3>
      <form id="decryptForm">
        <div class="form-group">
          <label for="encryptedFilePath">Encrypted File Path</label>
          <input
            type="text"
            id="encryptedFilePath"
            name="encrypted_file_path"
            required
            placeholder="encrypted_files/example.encrypted"
          />
        </div>
        <div class="form-group">
          <label for="decryptPassword">Decryption Password</label>
          <input
            type="password"
            id="decryptPassword"
            name="password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">Decrypt File</button>
      </form>
      <div id="decryptResult" class="result-display"></div>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("encryptForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append("file", document.getElementById("fileInput").files[0]);
      formData.append(
        "password",
        document.getElementById("encryptPassword").value
      );

      try {
        const response = await fetch("/api/encrypt_file", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          // Format file hash with hyphens every 8 chars so it can wrap inside the success box
          const rawHash =
            data.metadata && data.metadata.file_hash
              ? data.metadata.file_hash
              : "";
          const formattedHash = rawHash
            ? (rawHash.match(/.{1,8}/g) || []).join("-")
            : "";

          document.getElementById("encryptResult").innerHTML = `
                <div class="success-message">
                    <h4>File Encrypted Successfully!</h4>
                    <p><strong>Encrypted file:</strong> ${data.encrypted_file}</p>
                    <p><strong>File Hash:</strong> ${formattedHash}</p>
                    <p><em>Copy the encrypted file path above to decrypt later</em></p>
                </div>
            `;
          // Pre-fill the decrypt form with the encrypted file path
          document.getElementById("encryptedFilePath").value =
            data.encrypted_file;
        } else {
          document.getElementById("encryptResult").innerHTML = `
                <div class="error-message">Error: ${data.error}</div>
            `;
        }
      } catch (error) {
        document.getElementById("encryptResult").innerHTML = `
            <div class="error-message">Failed to encrypt file</div>
        `;
      }
    });

  document
    .getElementById("decryptForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = {
        encrypted_file_path: document.getElementById("encryptedFilePath").value,
        password: document.getElementById("decryptPassword").value,
      };

      try {
        const response = await fetch("/api/decrypt_file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (data.success) {
          const downloadUrl = data.download_url;
          // Use the filename provided by the backend (already extracted correctly)
          const fileName =
            data.decrypted_filename || data.decrypted_file.split(/[/\\]/).pop();

          document.getElementById("decryptResult").innerHTML = `
                <div class="success-message">
                    <h4>File Decrypted Successfully!</h4>
                    <p>Decrypted file: ${data.decrypted_file}</p>
                    <button onclick="downloadDecryptedFile('${downloadUrl}', '${fileName}')" class="btn btn-primary" style="margin-top: 10px;">
                         Download Decrypted File
                    </button>
                </div>
            `;
        } else {
          document.getElementById("decryptResult").innerHTML = `
                <div class="error-message">Error: ${data.error}</div>
            `;
        }
      } catch (error) {
        document.getElementById("decryptResult").innerHTML = `
            <div class="error-message">Failed to decrypt file</div>
        `;
      }
    });

  // Function to download decrypted file with proper error handling
  async function downloadDecryptedFile(url, filename) {
    try {
      const response = await fetch(url);

      if (!response.ok) {
        const errorData = await response
          .json()
          .catch(() => ({ error: "Failed to download file" }));
        alert("Error: " + (errorData.error || "Failed to download file"));
        return;
      }

      // Get the blob data
      const blob = await response.blob();

      // Create a temporary download link
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = downloadUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(downloadUrl);
    } catch (error) {
      alert("Error downloading file: " + error.message);
    }
  }
</script>
{% endblock %}
