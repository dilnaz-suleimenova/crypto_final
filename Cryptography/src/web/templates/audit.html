{% extends "base.html" %} {% block title %}Audit Trail - CryptoVault{% endblock
%} {% block content %}
<div class="container">
  <div class="page-header">
    <h1></i> Blockchain Audit Trail</h1>
    <p>Immutable log of all security events</p>
  </div>

  <div class="audit-controls">
    <button onclick="loadAuditTrail()" class="btn btn-primary">Refresh</button>
    <button onclick="verifyChain()" class="btn btn-secondary">
      Verify Chain Integrity
    </button>
  </div>

  <div id="auditTrail" class="audit-trail">
    <div class="loading">Loading audit trail...</div>
  </div>
</div>

<script>
  async function loadAuditTrail() {
    try {
      const response = await fetch("/api/audit_trail");
      const data = await response.json();

      if (data.success) {
        const trailDiv = document.getElementById("auditTrail");

        let html = "";

        // Show pending transactions if any
        if (data.pending_transactions > 0) {
          html += `<div class="block-card" style="opacity: 0.7; border: 2px dashed #666;">
                    <div class="block-header">
                        <h3>Pending Transactions</h3>
                        <span style="color: orange;">${data.pending_transactions} transaction(s) waiting</span>
                    </div>
                    <p>These will be added to the next block when it's created.</p>
                </div>`;
        }

        if (data.chain.length === 0) {
          trailDiv.innerHTML = "<p>No blocks in chain yet.</p>";
          return;
        }

        data.chain.forEach((block, index) => {
          html += `
                    <div class="block-card">
                        <div class="block-header">
                            <h3>Block #${block.index}</h3>
                            <span class="block-hash">${block.hash.substring(
                              0,
                              16
                            )}...</span>
                        </div>
                        <div class="block-details">
                            <p><strong>Previous Hash:</strong> ${block.previous_hash.substring(
                              0,
                              16
                            )}...</p>
                            <p><strong>Merkle Root:</strong> ${block.merkle_root.substring(
                              0,
                              16
                            )}...</p>
                            <p><strong>Nonce:</strong> ${block.nonce}</p>
                            <p><strong>Transactions:</strong> ${
                              block.transactions.length
                            }</p>
                        </div>
                        <div class="transactions">
                            ${block.transactions
                              .map(
                                (tx) => `
                                <div class="transaction">
                                    <strong>${tx.type}</strong>
                                    <pre>${JSON.stringify(
                                      tx.data,
                                      null,
                                      2
                                    )}</pre>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        });

        trailDiv.innerHTML = html;
      }
    } catch (error) {
      document.getElementById("auditTrail").innerHTML =
        '<div class="error-message">Failed to load audit trail</div>';
    }
  }

  async function verifyChain() {
    try {
      const response = await fetch("/api/verify_chain");
      const data = await response.json();

      if (data.success) {
        if (data.valid) {
          alert(
            `✅ Chain Verification Successful!\n\nChain Length: ${data.chain_length} blocks\nStatus: ${data.message}`
          );
        } else {
          alert(
            `❌ Chain Verification Failed!\n\n${data.message}\n\nThis indicates the blockchain has been tampered with.`
          );
        }
      } else {
        alert("Error: " + (data.error || "Failed to verify chain"));
      }
    } catch (error) {
      alert("Error: Failed to verify chain - " + error.message);
    }
  }

  // Load on page load
  loadAuditTrail();
</script>
{% endblock %}
